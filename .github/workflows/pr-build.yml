name: PR Build

on:
    pull_request_target:
        branches: [master]
        types: [opened, synchronize, reopened, labeled, closed]

permissions:
    contents: read
    pull-requests: write
    checks: write
    statuses: write
    actions: write

env:
    PLUGIN_ID: next-toc

jobs:
    # å®‰å…¨æ£€æŸ¥ä½œä¸š - éªŒè¯ PR æ¥æºå’Œæ ‡ç­¾äº‹ä»¶
    security-check:
        runs-on: ubuntu-latest
        outputs:
            is-safe: ${{ steps.check.outputs.is-safe }}
            should-build: ${{ steps.check.outputs.should-build }}
        steps:
            - name: Check PR safety and build conditions
              id: check
              run: |
                  echo "Event action: ${{ github.event.action }}"
                  echo "PR from: ${{ github.event.pull_request.head.repo.full_name }}"
                  echo "Target repo: ${{ github.repository }}"

                  # æ£€æŸ¥æ˜¯å¦åº”è¯¥æ„å»º
                  should_build="false"
                  is_safe="false"

                  # å¦‚æœæ˜¯ labeled äº‹ä»¶ï¼Œåªå¤„ç† safe-to-build æ ‡ç­¾
                  if [[ "${{ github.event.action }}" == "labeled" ]]; then
                    echo "Label added: ${{ github.event.label.name }}"
                    if [[ "${{ github.event.label.name }}" == "safe-to-build" ]]; then
                      echo "Safe-to-build label added, will proceed with build"
                      is_safe="true"
                      should_build="true"
                    else
                      echo "Other label added, skipping build"
                      is_safe="false"
                      should_build="false"
                    fi
                  else
                    # å…¶ä»–äº‹ä»¶ï¼ˆopened, synchronize, reopenedï¼‰çš„å®‰å…¨æ£€æŸ¥
                    if [[ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]]; then
                      echo "Internal PR detected, safe to build"
                      is_safe="true"
                      should_build="true"
                    elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'safe-to-build') }}" == "true" ]]; then
                      echo "External PR with safe-to-build label, safe to build"
                      is_safe="true"
                      should_build="true"
                    else
                      echo "External PR without safe-to-build label, skipping build"
                      is_safe="false"
                      should_build="false"
                    fi
                  fi

                  echo "is-safe=$is_safe" >> $GITHUB_OUTPUT
                  echo "should-build=$should_build" >> $GITHUB_OUTPUT

    build:
        runs-on: ubuntu-latest
        needs: security-check
        if: needs.security-check.outputs.should-build == 'true'
        steps:
            - name: Checkout PR code
              uses: actions/checkout@v4
              with:
                  # é‡è¦ï¼šæ£€å‡º PR çš„ä»£ç è€Œä¸æ˜¯ç›®æ ‡åˆ†æ”¯
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18.x"
                  cache: "npm"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build plugin
              run: yarn build

            - name: Prepare artifacts
              run: |
                  mkdir -p build-artifacts
                  TIMESTAMP=$(date +%s)
                  ARTIFACT_NAME="${{ env.PLUGIN_ID }}-pr-${TIMESTAMP}"
                  echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
                  cp main.js manifest.json styles.css build-artifacts/
                  cd build-artifacts
                  zip -r "${ARTIFACT_NAME}.zip" .

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.ARTIFACT_NAME }}
                  path: build-artifacts/
                  retention-days: 7

            - name: Comment on PR
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const shortSha = context.payload.pull_request.head.sha.substring(0, 7);
                      const runId = context.runId;
                      const eventAction = context.payload.action;

                      // æ ¹æ®è§¦å‘äº‹ä»¶ç”Ÿæˆä¸åŒçš„æ¶ˆæ¯
                      let triggerInfo = '';
                      if (eventAction === 'labeled') {
                        triggerInfo = `\n**è§¦å‘åŸå› ï¼š** æ·»åŠ äº† \`safe-to-build\` æ ‡ç­¾`;
                      } else {
                        triggerInfo = `\n**è§¦å‘åŸå› ï¼š** PR ${eventAction}`;
                      }

                      // åŒæ—¶åŒºæ˜¾ç¤º
                      const utcDate = new Date();
                      const beijingDate = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);
                      const formatBJ = beijingDate.toISOString().replace('T', ' ').replace('Z', '').slice(0, 19);

                      const commentBody = `## ğŸ”§ PR æ„å»ºå®Œæˆ

                      **æ„å»ºä¿¡æ¯ï¼š**
                      - PR: #${prNumber}
                      - Commit: ${shortSha}
                      - æ„å»ºæ—¶é—´ï¼ˆUTCï¼‰: ${utcDate.toISOString()}
                      - æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: ${formatBJ}${triggerInfo}

                      **ä¸‹è½½é“¾æ¥ï¼š**
                      [ä¸‹è½½æ’ä»¶æ„å»ºäº§ç‰©](https://github.com/${{ github.repository }}/actions/runs/${runId})

                      **å®‰è£…è¯´æ˜ï¼š**
                      1. ç‚¹å‡»ä¸Šæ–¹é“¾æ¥ä¸‹è½½æ„å»ºäº§ç‰©
                      2. è§£å‹ zip æ–‡ä»¶
                      3. å°†è§£å‹åçš„æ–‡ä»¶å¤¹å¤åˆ¶åˆ° Obsidian æ’ä»¶ç›®å½•ï¼š\`<vault>/.obsidian/plugins/${{ env.PLUGIN_ID }}/\`
                      4. åœ¨ Obsidian è®¾ç½®ä¸­å¯ç”¨æ’ä»¶

                      > âš ï¸ è¿™æ˜¯æµ‹è¯•æ„å»ºï¼Œä»…ç”¨äºé¢„è§ˆå’Œæµ‹è¯•ç›®çš„ã€‚`;

                      // æŸ¥æ‰¾ç°æœ‰çš„æ„å»ºè¯„è®º
                      const comments = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber
                      });

                      const existingComment = comments.data.find(comment => 
                        comment.user.login === 'github-actions[bot]' && 
                        comment.body.includes('ğŸ”§ PR æ„å»ºå®Œæˆ')
                      );

                      if (existingComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existingComment.id,
                          body: commentBody
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: prNumber,
                          body: commentBody
                        });
                      }

    build-status:
        runs-on: ubuntu-latest
        needs: [security-check, build]
        if: always() && needs.security-check.outputs.should-build == 'true'
        steps:
            - name: Set commit status
              uses: actions/github-script@v7
              with:
                  script: |
                      const state = '${{ needs.build.result }}' === 'success' ? 'success' : 'failure';
                      const description = state === 'success' ? 'PR æ„å»ºæˆåŠŸ' : 'PR æ„å»ºå¤±è´¥';

                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.pull_request.head.sha }}',
                        state: state,
                        description: description,
                        context: 'PR Build',
                        target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
                      });

    # å¯é€‰ï¼šä¸ºå¤–éƒ¨ PR æä¾›è¯´æ˜
    external-pr-info:
        runs-on: ubuntu-latest
        needs: security-check
        if: |
            needs.security-check.outputs.is-safe == 'false' && 
            github.event.action != 'labeled' &&
            github.event.pull_request.head.repo.full_name != github.repository
        steps:
            - name: Comment on external PR
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;

                      const commentBody = `## ğŸ”’ å¤–éƒ¨ PR å®‰å…¨æ£€æŸ¥

                      æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ç”±äºè¿™æ˜¯æ¥è‡ªå¤–éƒ¨ä»“åº“çš„ PRï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œè‡ªåŠ¨æ„å»ºå·²è¢«æš‚åœã€‚

                      **ä¸‹ä¸€æ­¥ï¼š**
                      ç»´æŠ¤è€…å°†å®¡æŸ¥æ‚¨çš„ä»£ç ï¼Œå¦‚æœå®‰å…¨æ— é—®é¢˜ï¼Œä¼šæ·»åŠ  \`safe-to-build\` æ ‡ç­¾æ¥è§¦å‘æ„å»ºã€‚

                      **è¯·è€å¿ƒç­‰å¾…ç»´æŠ¤è€…å®¡æŸ¥ã€‚** ğŸ™`;

                      // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç±»ä¼¼è¯„è®º
                      const comments = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber
                      });

                      const existingComment = comments.data.find(comment => 
                        comment.user.login === 'github-actions[bot]' && 
                        comment.body.includes('ğŸ”’ å¤–éƒ¨ PR å®‰å…¨æ£€æŸ¥')
                      );

                      if (!existingComment) {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: prNumber,
                          body: commentBody
                        });
                      }

    # PR å…³é—­åæ¸…ç†æ„å»ºäº§ç‰©ï¼ˆåŒ…æ‹¬åˆå¹¶å’Œæœªåˆå¹¶çš„æƒ…å†µï¼‰
    cleanup-artifacts:
        runs-on: ubuntu-latest
        if: github.event.action == 'closed'
        steps:
            - name: Delete PR build artifacts
              uses: actions/github-script@v7
              env:
                  PLUGIN_ID: ${{ env.PLUGIN_ID }}
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const pluginId = process.env.PLUGIN_ID
                      const isMerged = context.payload.pull_request.merged;

                      console.log(`Starting cleanup for PR #${prNumber} (${isMerged ? 'merged' : 'closed without merge'}) with plugin ID: ${pluginId}`);

                      // è·å–å·¥ä½œæµè¿è¡Œåˆ—è¡¨
                      const workflowRuns = await github.rest.actions.listWorkflowRuns({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'pr-build.yml',
                        head_sha: context.payload.pull_request.head.sha
                      });

                      console.log(`Found ${workflowRuns.data.workflow_runs.length} workflow runs for PR #${prNumber}`);

                      let deletedCount = 0;
                      let errorCount = 0;

                      // éå†å·¥ä½œæµè¿è¡Œï¼Œåˆ é™¤ç›¸å…³çš„æ„å»ºäº§ç‰©
                      for (const run of workflowRuns.data.workflow_runs) {
                        try {
                          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            run_id: run.id
                          });
                          
                          console.log(`Run ${run.id}: Found ${artifacts.data.artifacts.length} artifacts`);
                          
                          for (const artifact of artifacts.data.artifacts) {
                            // åªåˆ é™¤ PR æ„å»ºäº§ç‰©ï¼ˆä»¥ plugin-id-pr- å¼€å¤´çš„ï¼‰
                            if (artifact.name.includes(`${pluginId}-pr-`)) {
                              console.log(`Deleting artifact: ${artifact.name} (ID: ${artifact.id})`);
                              await github.rest.actions.deleteArtifact({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                artifact_id: artifact.id
                              });
                              deletedCount++;
                            }
                          }
                        } catch (error) {
                          console.log(`Error processing run ${run.id}: ${error.message}`);
                          errorCount++;
                          // ç»§ç»­å¤„ç†å…¶ä»–è¿è¡Œï¼Œä¸å› å•ä¸ªé”™è¯¯è€Œåœæ­¢
                        }
                      }

                      console.log(`Cleanup completed: ${deletedCount} artifacts deleted, ${errorCount} errors occurred`);

                      // è®¾ç½®è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
                      core.setOutput('deleted-count', deletedCount);
                      core.setOutput('error-count', errorCount);
                      core.setOutput('is-merged', isMerged);

            - name: Update PR comment
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const isMerged = context.payload.pull_request.merged;

                      // æŸ¥æ‰¾ç°æœ‰çš„æ„å»ºè¯„è®º
                      const comments = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber
                      });

                      const existingComment = comments.data.find(comment => 
                        comment.user.login === 'github-actions[bot]' && 
                        comment.body.includes('ğŸ”§ PR æ„å»ºå®Œæˆ')
                      );

                      if (existingComment) {
                        const statusMessage = isMerged 
                          ? 'âœ… **PR å·²åˆå¹¶ï¼Œæ„å»ºäº§ç‰©å·²è‡ªåŠ¨æ¸…ç†**'
                          : 'ğŸ—‘ï¸ **PR å·²å…³é—­ï¼Œæ„å»ºäº§ç‰©å·²è‡ªåŠ¨æ¸…ç†**';
                        const updatedBody = existingComment.body + `\n\n---\n\n${statusMessage}`;
                        
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existingComment.id,
                          body: updatedBody
                        });
                      }
